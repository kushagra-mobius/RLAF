name: Upload Model to CDN
description: Takes a model file, uploads it to a CDN using curl, and returns the public URL.

inputs:
- name: model_path
  type: String
  description: 'Path to the model file to be uploaded.'

outputs:
- name: cdn_url
  type: String
  description: 'The public URL of the uploaded model on the CDN.'

implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -ec
      - |
        # The container image needs curl
        if ! command -v curl &> /dev/null; then
            echo "curl could not be found, installing..."
            apt-get update && apt-get install -y curl
        fi
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import subprocess
        import json
        import os

        parser = argparse.ArgumentParser(description="Upload a model to a CDN.")
        parser.add_argument('--model-path', type=str, required=True, help='Path to the model file.')
        parser.add_argument('--cdn-url', type=str, required=True, help='Path to the output file for the CDN URL.')
        args = parser.parse_args()

        def upload_model_to_cdn(model_path, cdn_url_path):
            """
            Uploads a model file to a CDN and outputs the public URL.
            """
            # WARNING: It is strongly recommended to manage sensitive data like bearer tokens
            # through secure means, such as Kubernetes secrets, rather than hardcoding them.
            bearer_token = "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI3Ny1NUVdFRTNHZE5adGlsWU5IYmpsa2dVSkpaWUJWVmN1UmFZdHl5ejFjIn0.eyJleHAiOjE3NTMzOTM3MzksImlhdCI6MTc1MzM1NzczOSwianRpIjoiYjEwMWFjYWMtOWY4Ni00MTQ0LTkyMTItYTE1YmJmYWFiMDIyIiwiaXNzIjoiaHR0cDovL2tleWNsb2FrLXNlcnZpY2Uua2V5Y2xvYWsuc3ZjLmNsdXN0ZXIubG9jYWw6ODA4MC9yZWFsbXMvbWFzdGVyIiwiYXVkIjpbIkJPTFRaTUFOTl9CT1RfbW9iaXVzIiwiUEFTQ0FMX0lOVEVMTElHRU5DRV9tb2JpdXMiLCJNT05FVF9tb2JpdXMiLCJWSU5DSV9tb2JpdXMiLCJhY2NvdW50Il0sInN1YiI6IjJjZjc2ZTVmLTI2YWQtNGYyYy1iY2NjLWY0YmMxZTdiZmI2NCIsInR5cCI6IkJlYXJlciIsImF6cCI6IkhPTEFDUkFDWV9tb2JpdXMiLCJzaWQiOiJiNDI0NmFiNy0zNGIzLTRlZjctYmY1OS03NTYzODA0MDFkMTAiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbIi8qIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfc3JlX2FkbWluIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX2JyX2FkbWluIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX3NlY3VyaXR5X2FkbWluIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX2RjZHJfYWRtaW4iLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfQWxlcnRzX1JlYWQiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfY2RfZXhlY3V0ZSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9pYWNfZXhlY3V0ZSIsIjllNzYxYjc4LTY4YjgtNDE2Ny04MjNhLWlwMV90ZXN0X2N1c3RvbV9wcm9kdWN0X3JvbGUxMjM0NTYiLCJ1bWFfYXV0aG9yaXphdGlvbiIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9kY2RyX2V4ZWN1dGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfYnJfcmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9rOHNfcmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9DdXN0b21lcl9Xcml0ZSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9jaV93cml0ZSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9zcmVfd3JpdGUiLCIwYmM0OWZhZC05MTIzLTRjYWItYWI5YS0wNTU2Nzk2MDBkMjhfYzFhNzU2NjctYjM1ZC00NmNhLWJkNGEtZDk1NGY1YmIyY2Y5X3Rlc3Ricl9yZWFkIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX2RjZHJfcmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9BcHByb3ZhbHNfV3JpdGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfUm9sZXNfUmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9BbGVydHNfV3JpdGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfazhzX3dyaXRlIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX2lhY19hZG1pbiIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9Qb2xpY2llc19SZWFkIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX2NkX2FkbWluIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX2NpX3JlYWQiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfSW5mcmFfV3JpdGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfUm9sZXNfV3JpdGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfc3JlX2V4ZWN1dGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfSW5mcmFfUmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9kY2RyX3dyaXRlIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX0xvZ3NfUmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9pYWNfcmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9rOHNfZXhlY3V0ZSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9UZWFtX1dyaXRlIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX3NlY3VyaXR5X2V4ZWN1dGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfY2RfcmVhZCIsIm9mZmxpbmVfYWNjZXNzIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX1BvbGljaWVzX1dyaXRlIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX3NlY3VyaXR5X3dyaXRlIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX1Byb2plY3RfV3JpdGUiLCJtb2JpdXNfZDBmNTJiMGUtMzZkNy00ODUzLTg4NjAtNmQyMWE5YTkyMGE1X0FCQ0QiLCJkZWZhdWx0LXJvbGVzLW1hc3RlciIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9DdXN0b21lcl9SZWFkIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX1RlYW1fUmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9icl9leGVjdXRlIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX2s4c19hZG1pbiIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9Qcm9qZWN0X1JlYWQiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfTG9nc19Xcml0ZSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9jZF93cml0ZSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9icl93cml0ZSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9zcmVfcmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9Vc2VyX1dyaXRlIiwiOWU3NjFiNzgtNjhiOC00MTY3LTgyM2EtaXAxX2YwYzFiODkzLWRjYTYtNGRkMS05MjI5LWlwMV90ZXN0X2N1c3RvbV9wcm9kdWN0X3JvbGUxMjM0NSIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9pYWNfd3JpdGUiLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfY2lfYWRtaW4iLCI2N2UxNDcxNTA2ZGE3NTJiNzg3MTZkMjFfc2VjdXJpdHlfcmVhZCIsIjY3ZTE0NzE1MDZkYTc1MmI3ODcxNmQyMV9jaV9leGVjdXRlIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX0FwcHJvdmFsc19SZWFkIiwiNjdlMTQ3MTUwNmRhNzUyYjc4NzE2ZDIxX1VzZXJfUmVhZCJdfSwicmVzb3VyY2VfYWNjZXNzIjp7IkJPTFRaTUFOTl9CT1RfbW9iaXVzIjp7InJvbGVzIjpbIkJPTFRaTUFOTl9CT1RfVVNFUiIsIkJPTFRaTUFOTl9CT1RfQURNSU4iXX0sIkhPTEFDUkFDWV9tb2JpdXMiOnsicm9sZXMiOlsiSE9MQUNSQUNZX1VTRVIiXX0sIlBBU0NBTF9JTlRFTExJR0VOQ0VfbW9iaXVzIjp7InJvbGVzIjpbIlBBU0NBTF9JTlRFTExJR0VOQ0VfQ09OU1VNRVIiLCJQQVNDQUxfSU5URUxMSUdFTkNFX1VTRVIiLCJQQVNDQUxfSU5URUxMSUdFTkNFX0FETUlOIiwiU0NIRU1BX1JFQUQiXX0sIk1PTkVUX21vYml1cyI6eyJyb2xlcyI6WyJNT05FVF9BUFBST1ZFIiwiTU9ORVRfVVNFUiJdfSwiVklOQ0lfbW9iaXVzIjp7InJvbGVzIjpbIlZJTkNJX1VTRVIiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInJlcXVlc3RlclR5cGUiOiJURU5BTlQiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwibmFtZSI6IkFpZHRhYXMgQWlkdGFhcyIsInRlbmFudElkIjoiMmNmNzZlNWYtMjZhZC00ZjJjLWJjY2MtZjRiYzFlN2JmYjY0IiwicGxhdGZvcm1JZCI6Im1vYml1cyIsInByZWZlcnJlZF91c2VybmFtZSI6InBhc3N3b3JkX3RlbmFudF9haWR0YWFzQGdhaWFuc29sdXRpb25zLmNvbSIsImdpdmVuX25hbWUiOiJBaWR0YWFzIiwiZmFtaWx5X25hbWUiOiJBaWR0YWFzIiwiZW1haWwiOiJwYXNzd29yZF90ZW5hbnRfYWlkdGFhc0BnYWlhbnNvbHV0aW9ucy5jb20iLCJwbGF0Zm9ybXMiOnsicm9sZXMiOlsiU0NIRU1BX1JFQUQiXX19.aU1Qq-zNiasF7cMvDKjxye4AJDauKYj-2bKNjTtSkIgTGlE4Tqxl69wNBrZBZix-6l8d9nnuvD85WMJIH9MyK6U5g_Q8HxCz2l8z3InWO-k6i_8Gp8U1AEVTxMlTYNjp_vL3WooNpLulLaE71Bp58GgO4IZzalCh7zmkTtaNzZGanQsAXObMrxisRp3VlSak5MX2KfRFNSLlFAEXLt_7NdNKjSZAZ5c-i5X2WJm0rijSz0_0pKJ9NR_mJ0vCPnRgOxZnfNsdXRz988FS_QC6ZzWthkE59WTC1W56PmDPACMV2HzrAK6Iq8lVWRp2UL1V_fFH6FJ2xFacTKDClkOXfw"
            upload_url = "https://ig.mobiusdtaas.ai/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"

            print(f"Uploading model from {model_path} to {upload_url}...")

            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f'file=@"{model_path}"',
                "--fail",
                "--show-error"
            ]

            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    text=True,
                    check=True
                )
                
                print("Upload successful. Raw response:")
                print(process.stdout)

                response_json = json.loads(process.stdout)
                
                # This part is critical and has been updated based on the actual API response.
                # It extracts the 'cdnUrl' key and prepends the base URL to form the final URL.
                relative_cdn_url = response_json.get("cdnUrl", "URL_NOT_FOUND")

                if relative_cdn_url == "URL_NOT_FOUND":
                    print("Error: Could not find 'cdnUrl' in the server response.")
                    print("Full response:", process.stdout)
                    raise ValueError("Failed to parse cdnUrl from CDN response.")
                
                content_url_value = f"https://cdn.mobiusdtaas.ai{relative_cdn_url}"

                print(f"Extracted CDN URL: {content_url_value}")

                os.makedirs(os.path.dirname(cdn_url_path), exist_ok=True)
                with open(cdn_url_path, "w") as f:
                    f.write(content_url_value)

            except subprocess.CalledProcessError as e:
                print("Error executing curl command:")
                print(f"Return code: {e.returncode}")
                print(f"Output: {e.stdout}")
                print(f"Error Output: {e.stderr}")
                raise e
            except (json.JSONDecodeError, KeyError, ValueError) as e:
                print(f"Error processing the server response: {e}")
                raise e

        upload_model_to_cdn(args.model_path, args.cdn_url)

    args:
      - --model-path
      - {inputValue: model_path}
      - --cdn-url
      - {outputPath: cdn_url}